{% extends 'base.html' %}

{% block title %}{{ movie.title }} - Art House Cinema{% endblock %}

{% block content %}
<!-- Movie Header -->
<div class="movie-detail-header" style="background-image: url('{{ movie.poster_url }}');">
    <div class="movie-detail-overlay d-flex align-items-end">
        <div class="container">
            <div class="row">
                <div class="col-md-3">
                    {% if movie.poster_url %}
                        <img src="{{ movie.poster_url }}" class="img-fluid rounded" alt="{{ movie.title }}">
                    {% else %}
                        <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="height: 450px;">
                            <i class="fas fa-film fa-3x text-light"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="col-md-9">
                    <h1 class="display-4">{{ movie.title }} ({{ movie.release_year }})</h1>
                    <p class="lead">Directed by {{ movie.director }}</p>
                    <div class="mb-3">
                        {% for i in "12345"|make_list %}
                            {% if forloop.counter <= average_rating %}
                                <i class="fas fa-star rating-star fa-lg"></i>
                            {% else %}
                                <i class="far fa-star rating-star fa-lg"></i>
                            {% endif %}
                        {% endfor %}
                        <span class="ms-2 fs-4">({{ movie.total_ratings }} reviews)</span>
                        {% if average_rating %}
                            <span class="ms-2 fs-4">{{ average_rating|floatformat:1 }}</span>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-3">
                        {% if user.is_authenticated %}
                            <button class="btn btn-outline-light favorite-btn" data-movie-id="{{ movie.slug }}">
                                <i class="{% if movie in user.favorite_movies.all %}fas{% else %}far{% endif %} fa-heart"></i>
                                {% if movie in user.favorite_movies.all %}Remove from{% else %}Add to{% endif %} Favorites
                            </button>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#reviewModal">
                                Write a Review
                            </button>
                        {% else %}
                            <a href="{% url 'users:login' %}" class="btn btn-primary">Login to Review</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Movie Details -->
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-body">
                    <h3>About the Film</h3>
                    <p class="lead">{{ movie.description }}</p>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Movement</h5>
                            <p>{{ movie.movement }}</p>
                            <h5>Country</h5>
                            <p>{{ movie.country }}</p>
                        </div>
                        <div class="col-md-6">
                            <h5>Runtime</h5>
                            <p>{{ movie.runtime }} minutes</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reviews Section -->
            <h3 class="mb-4">Reviews</h3>
            {% for review in reviews %}
            <div class="card review-card mb-3">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="card-title mb-0">{{ review.user.username }}</h5>
                        <div>
                            {% for i in "12345"|make_list %}
                                {% if forloop.counter <= review.score %}
                                    <i class="fas fa-star rating-star"></i>
                                {% else %}
                                    <i class="far fa-star rating-star"></i>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                    <p class="card-text">{{ review.text }}</p>
                    <small class="text-muted">Posted on {{ review.created_at|date:"F j, Y" }}</small>
                </div>
            </div>
            {% empty %}
            <div class="alert alert-info">
                No reviews yet. Be the first to review this movie!
            </div>
            {% endfor %}

            <!-- Pagination for reviews -->
            {% if reviews.is_paginated %}
            <nav class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if reviews.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ reviews.previous_page_number }}">Previous</a>
                        </li>
                    {% endif %}

                    {% for num in reviews.paginator.page_range %}
                        {% if reviews.number == num %}
                            <li class="page-item active">
                                <span class="page-link">{{ num }}</span>
                            </li>
                        {% elif num > reviews.number|add:'-3' and num < reviews.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if reviews.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ reviews.next_page_number }}">Next</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-body">
                    <h4>Similar Movies</h4>
                    {% for similar_movie in similar_movies %}
                    <div class="d-flex mb-3">
                        {% if similar_movie.poster_url %}
                            <img src="{{ similar_movie.poster_url }}" class="rounded" alt="{{ similar_movie.title }}" style="width: 100px; height: 150px; object-fit: cover;">
                        {% else %}
                            <div class="bg-secondary rounded d-flex align-items-center justify-content-center" style="width: 100px; height: 150px;">
                                <i class="fas fa-film text-light"></i>
                            </div>
                        {% endif %}
                        <div class="ms-3">
                            <h6><a href="{% url 'movies:movie-detail' similar_movie.slug %}" class="text-decoration-none">{{ similar_movie.title }}</a></h6>
                            <p class="text-muted mb-1">{{ similar_movie.release_year }}</p>
                            <div>
                                {% for i in "12345"|make_list %}
                                    {% if forloop.counter <= similar_movie.average_rating %}
                                        <i class="fas fa-star rating-star small"></i>
                                    {% else %}
                                        <i class="far fa-star rating-star small"></i>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-muted">No similar movies found.</p>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Review Modal -->
{% if user.is_authenticated %}
<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Write a Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reviewForm">
                    <div class="mb-3">
                        <label class="form-label">Rating</label>
                        <div class="rating-input">
                            {% for i in "12345"|make_list %}
                            <input type="radio" name="rating" value="{{ forloop.counter }}" id="star{{ forloop.counter }}" required>
                            <label for="star{{ forloop.counter }}">
                                <i class="far fa-star rating-star"></i>
                            </label>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Your Review</label>
                        <textarea class="form-control" id="comment" name="comment" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitReview">Submit Review</button>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Favorite button functionality
    const favoriteBtn = document.querySelector('.favorite-btn');
    if (favoriteBtn) {
        favoriteBtn.addEventListener('click', function() {
            const movieSlug = this.dataset.movieId;
            fetch(`/api/v1/movies/${movieSlug}/favorite/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                const icon = this.querySelector('i');
                icon.classList.toggle('fas');
                icon.classList.toggle('far');
                this.textContent = icon.classList.contains('fas') ? 'Remove from Favorites' : 'Add to Favorites';
                this.prepend(icon);
            })
            .catch(error => console.error('Error:', error));
        });
    }

    // Review form functionality
    const reviewForm = document.getElementById('reviewForm');
    const submitReview = document.getElementById('submitReview');
    const ratingInputs = document.querySelectorAll('.rating-input input');
    const ratingLabels = document.querySelectorAll('.rating-input label i');

    // Star rating hover effect
    ratingInputs.forEach((input, index) => {
        input.addEventListener('change', () => updateStars(index + 1));
        input.addEventListener('mouseover', () => {
            ratingLabels.forEach((label, i) => {
                label.classList.remove('fas', 'far');
                label.classList.add(i <= index ? 'fas' : 'far');
            });
        });
    });

    document.querySelector('.rating-input').addEventListener('mouseout', () => {
        const selectedRating = document.querySelector('.rating-input input:checked');
        if (selectedRating) {
            updateStars(selectedRating.value);
        } else {
            ratingLabels.forEach(label => {
                label.classList.remove('fas');
                label.classList.add('far');
            });
        }
    });

    function updateStars(rating) {
        ratingLabels.forEach((label, index) => {
            label.classList.remove('fas', 'far');
            label.classList.add(index < rating ? 'fas' : 'far');
        });
    }

    // Submit review
    if (submitReview) {
        submitReview.addEventListener('click', function() {
            const rating = document.querySelector('input[name="rating"]:checked')?.value;
            const comment = document.getElementById('comment').value;

            if (!rating || !comment) {
                alert('Please provide both a rating and a comment.');
                return;
            }

            fetch(`/api/v1/movies/${movieSlug}/reviews/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rating: parseInt(rating),
                    comment: comment
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('There was an error submitting your review. Please try again.');
            });
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}

{% endblock %} 